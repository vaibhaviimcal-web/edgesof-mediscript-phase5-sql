<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phase 5: Inventory & Analytics SQL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .code-block {
      background: #1e293b;
      color: #e2e8f0;
      padding: 24px;
      border-radius: 12px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      max-height: 600px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen p-8">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl shadow-2xl p-10 mb-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">ðŸ“¦ Phase 5: Inventory & Analytics SQL</h1>
      <p class="text-xl text-gray-600 mb-8">Stock Management, Purchase Orders, Reports & Business Intelligence</p>

      <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-8 rounded-2xl mb-8">
        <h2 class="text-2xl font-bold mb-4">ðŸ“¦ What This Migration Adds:</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <h3 class="font-bold mb-2">Inventory Management:</h3>
            <ul class="text-sm space-y-1">
              <li>âœ“ Medicine stock tracking</li>
              <li>âœ“ Batch management</li>
              <li>âœ“ Expiry tracking</li>
              <li>âœ“ Stock alerts</li>
              <li>âœ“ Stock movements</li>
            </ul>
          </div>
          <div>
            <h3 class="font-bold mb-2">Purchase & Analytics:</h3>
            <ul class="text-sm space-y-1">
              <li>âœ“ Supplier management</li>
              <li>âœ“ Purchase orders</li>
              <li>âœ“ Revenue reports</li>
              <li>âœ“ Patient analytics</li>
              <li>âœ“ Doctor performance</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="bg-orange-50 border-l-4 border-orange-500 p-6 rounded-xl mb-8">
        <h3 class="font-bold text-orange-900 mb-2">ðŸ“‹ Instructions:</h3>
        <ol class="list-decimal list-inside space-y-2 text-orange-800">
          <li>Click "Copy SQL" button below</li>
          <li>Go to Supabase Dashboard â†’ SQL Editor</li>
          <li>Click "New Query"</li>
          <li>Paste the SQL</li>
          <li>Click "Run"</li>
        </ol>
      </div>

      <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900">Complete SQL Migration</h2>
          <button onclick="copySQL()" id="copyBtn" class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition transform hover:scale-105">
            ðŸ“‹ Copy SQL
          </button>
        </div>
        
        <div class="code-block" id="sqlCode">-- EdgesOf MediScript - Phase 5: Inventory & Analytics Migration
-- Stock Management, Purchase Orders, and Business Intelligence

-- =====================================================
-- SUPPLIERS
-- =====================================================

CREATE TABLE IF NOT EXISTS suppliers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    supplier_code VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    contact_person VARCHAR(255),
    phone VARCHAR(20),
    email VARCHAR(255),
    address TEXT,
    city VARCHAR(100),
    state VARCHAR(100),
    pincode VARCHAR(10),
    gstin VARCHAR(15),
    pan VARCHAR(10),
    payment_terms VARCHAR(100),
    credit_days INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- MEDICINE INVENTORY
-- =====================================================

CREATE TABLE IF NOT EXISTS medicine_inventory (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    medicine_id UUID REFERENCES medicines(id) ON DELETE CASCADE,
    clinic_id UUID REFERENCES clinics(id) ON DELETE CASCADE,
    batch_number VARCHAR(100) NOT NULL,
    expiry_date DATE NOT NULL,
    quantity_in_stock INTEGER NOT NULL DEFAULT 0,
    unit_cost DECIMAL(10,2),
    mrp DECIMAL(10,2),
    reorder_level INTEGER DEFAULT 10,
    location VARCHAR(100),
    supplier_id UUID REFERENCES suppliers(id),
    received_date DATE,
    is_expired BOOLEAN DEFAULT false,
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(medicine_id, batch_number)
);

-- =====================================================
-- STOCK MOVEMENTS
-- =====================================================

CREATE TABLE IF NOT EXISTS stock_movements (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    inventory_id UUID REFERENCES medicine_inventory(id) ON DELETE CASCADE,
    movement_type VARCHAR(50) CHECK (movement_type IN ('purchase', 'sale', 'return', 'adjustment', 'expired', 'damaged')),
    quantity INTEGER NOT NULL,
    reference_type VARCHAR(50),
    reference_id UUID,
    performed_by UUID REFERENCES users(id),
    reason TEXT,
    movement_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- PURCHASE ORDERS
-- =====================================================

CREATE TABLE IF NOT EXISTS purchase_orders (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    po_number VARCHAR(50) UNIQUE NOT NULL,
    clinic_id UUID REFERENCES clinics(id) ON DELETE CASCADE,
    supplier_id UUID REFERENCES suppliers(id),
    order_date DATE NOT NULL,
    expected_delivery_date DATE,
    actual_delivery_date DATE,
    status VARCHAR(50) DEFAULT 'draft' CHECK (status IN ('draft', 'sent', 'confirmed', 'partially_received', 'received', 'cancelled')),
    subtotal DECIMAL(10,2) DEFAULT 0,
    tax_amount DECIMAL(10,2) DEFAULT 0,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    total_amount DECIMAL(10,2) DEFAULT 0,
    payment_status VARCHAR(50) DEFAULT 'pending' CHECK (payment_status IN ('pending', 'partial', 'paid')),
    payment_terms VARCHAR(100),
    notes TEXT,
    created_by UUID REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- PURCHASE ORDER ITEMS
-- =====================================================

CREATE TABLE IF NOT EXISTS purchase_order_items (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    po_id UUID REFERENCES purchase_orders(id) ON DELETE CASCADE,
    medicine_id UUID REFERENCES medicines(id),
    quantity_ordered INTEGER NOT NULL,
    quantity_received INTEGER DEFAULT 0,
    unit_cost DECIMAL(10,2) NOT NULL,
    tax_rate DECIMAL(5,2) DEFAULT 0,
    discount_percent DECIMAL(5,2) DEFAULT 0,
    total_amount DECIMAL(10,2),
    batch_number VARCHAR(100),
    expiry_date DATE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- STOCK ALERTS
-- =====================================================

CREATE TABLE IF NOT EXISTS stock_alerts (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    inventory_id UUID REFERENCES medicine_inventory(id) ON DELETE CASCADE,
    alert_type VARCHAR(50) CHECK (alert_type IN ('low_stock', 'out_of_stock', 'expiring_soon', 'expired')),
    alert_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    is_acknowledged BOOLEAN DEFAULT false,
    acknowledged_by UUID REFERENCES users(id),
    acknowledged_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- ANALYTICS & REPORTS
-- =====================================================

-- Revenue analytics
CREATE TABLE IF NOT EXISTS revenue_analytics (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    clinic_id UUID REFERENCES clinics(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    total_revenue DECIMAL(10,2) DEFAULT 0,
    consultation_revenue DECIMAL(10,2) DEFAULT 0,
    medicine_revenue DECIMAL(10,2) DEFAULT 0,
    lab_revenue DECIMAL(10,2) DEFAULT 0,
    total_patients INTEGER DEFAULT 0,
    new_patients INTEGER DEFAULT 0,
    follow_up_patients INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(clinic_id, date)
);

-- Doctor performance
CREATE TABLE IF NOT EXISTS doctor_performance (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    doctor_id UUID REFERENCES users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    total_consultations INTEGER DEFAULT 0,
    total_revenue DECIMAL(10,2) DEFAULT 0,
    avg_consultation_time_minutes INTEGER,
    patient_satisfaction_score DECIMAL(3,2),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(doctor_id, date)
);

-- Patient demographics
CREATE TABLE IF NOT EXISTS patient_demographics (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    clinic_id UUID REFERENCES clinics(id) ON DELETE CASCADE,
    age_group VARCHAR(20),
    gender VARCHAR(20),
    patient_count INTEGER DEFAULT 0,
    last_updated TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Disease trends
CREATE TABLE IF NOT EXISTS disease_trends (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    clinic_id UUID REFERENCES clinics(id) ON DELETE CASCADE,
    disease_name VARCHAR(255) NOT NULL,
    icd_code VARCHAR(20),
    month DATE NOT NULL,
    case_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(clinic_id, disease_name, month)
);

-- =====================================================
-- INDEXES
-- =====================================================

CREATE INDEX IF NOT EXISTS idx_suppliers_code ON suppliers(supplier_code);
CREATE INDEX IF NOT EXISTS idx_suppliers_active ON suppliers(is_active);

CREATE INDEX IF NOT EXISTS idx_medicine_inventory_medicine ON medicine_inventory(medicine_id);
CREATE INDEX IF NOT EXISTS idx_medicine_inventory_clinic ON medicine_inventory(clinic_id);
CREATE INDEX IF NOT EXISTS idx_medicine_inventory_expiry ON medicine_inventory(expiry_date);
CREATE INDEX IF NOT EXISTS idx_medicine_inventory_batch ON medicine_inventory(batch_number);

CREATE INDEX IF NOT EXISTS idx_stock_movements_inventory ON stock_movements(inventory_id);
CREATE INDEX IF NOT EXISTS idx_stock_movements_type ON stock_movements(movement_type);
CREATE INDEX IF NOT EXISTS idx_stock_movements_date ON stock_movements(movement_date);

CREATE INDEX IF NOT EXISTS idx_purchase_orders_po_number ON purchase_orders(po_number);
CREATE INDEX IF NOT EXISTS idx_purchase_orders_supplier ON purchase_orders(supplier_id);
CREATE INDEX IF NOT EXISTS idx_purchase_orders_status ON purchase_orders(status);
CREATE INDEX IF NOT EXISTS idx_purchase_orders_date ON purchase_orders(order_date);

CREATE INDEX IF NOT EXISTS idx_stock_alerts_inventory ON stock_alerts(inventory_id);
CREATE INDEX IF NOT EXISTS idx_stock_alerts_type ON stock_alerts(alert_type);
CREATE INDEX IF NOT EXISTS idx_stock_alerts_acknowledged ON stock_alerts(is_acknowledged);

CREATE INDEX IF NOT EXISTS idx_revenue_analytics_clinic ON revenue_analytics(clinic_id);
CREATE INDEX IF NOT EXISTS idx_revenue_analytics_date ON revenue_analytics(date);

CREATE INDEX IF NOT EXISTS idx_doctor_performance_doctor ON doctor_performance(doctor_id);
CREATE INDEX IF NOT EXISTS idx_doctor_performance_date ON doctor_performance(date);

CREATE INDEX IF NOT EXISTS idx_disease_trends_clinic ON disease_trends(clinic_id);
CREATE INDEX IF NOT EXISTS idx_disease_trends_month ON disease_trends(month);

-- =====================================================
-- FUNCTIONS & TRIGGERS
-- =====================================================

-- Auto-generate PO number
CREATE OR REPLACE FUNCTION generate_po_number()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.po_number IS NULL THEN
        NEW.po_number := 'PO' || TO_CHAR(NOW(), 'YYYYMMDD') || '-' || LPAD(NEXTVAL('po_number_seq')::TEXT, 4, '0');
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE SEQUENCE IF NOT EXISTS po_number_seq;

DROP TRIGGER IF EXISTS set_po_number ON purchase_orders;
CREATE TRIGGER set_po_number
    BEFORE INSERT ON purchase_orders
    FOR EACH ROW
    EXECUTE FUNCTION generate_po_number();

-- Auto-generate supplier code
CREATE OR REPLACE FUNCTION generate_supplier_code()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.supplier_code IS NULL THEN
        NEW.supplier_code := 'SUP' || LPAD(NEXTVAL('supplier_code_seq')::TEXT, 5, '0');
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE SEQUENCE IF NOT EXISTS supplier_code_seq;

DROP TRIGGER IF EXISTS set_supplier_code ON suppliers;
CREATE TRIGGER set_supplier_code
    BEFORE INSERT ON suppliers
    FOR EACH ROW
    EXECUTE FUNCTION generate_supplier_code();

-- Check expiry and create alerts
CREATE OR REPLACE FUNCTION check_expiry_and_stock()
RETURNS TRIGGER AS $$
BEGIN
    -- Check if expired
    IF NEW.expiry_date < CURRENT_DATE THEN
        NEW.is_expired := true;
        
        -- Create expired alert
        INSERT INTO stock_alerts (inventory_id, alert_type)
        VALUES (NEW.id, 'expired')
        ON CONFLICT DO NOTHING;
    END IF;
    
    -- Check if expiring soon (within 30 days)
    IF NEW.expiry_date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '30 days' THEN
        INSERT INTO stock_alerts (inventory_id, alert_type)
        VALUES (NEW.id, 'expiring_soon')
        ON CONFLICT DO NOTHING;
    END IF;
    
    -- Check low stock
    IF NEW.quantity_in_stock <= NEW.reorder_level AND NEW.quantity_in_stock > 0 THEN
        INSERT INTO stock_alerts (inventory_id, alert_type)
        VALUES (NEW.id, 'low_stock')
        ON CONFLICT DO NOTHING;
    END IF;
    
    -- Check out of stock
    IF NEW.quantity_in_stock <= 0 THEN
        INSERT INTO stock_alerts (inventory_id, alert_type)
        VALUES (NEW.id, 'out_of_stock')
        ON CONFLICT DO NOTHING;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS check_expiry_and_stock_trigger ON medicine_inventory;
CREATE TRIGGER check_expiry_and_stock_trigger
    BEFORE INSERT OR UPDATE ON medicine_inventory
    FOR EACH ROW
    EXECUTE FUNCTION check_expiry_and_stock();

-- Update stock on movement
CREATE OR REPLACE FUNCTION update_stock_on_movement()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.movement_type IN ('purchase', 'return') THEN
        UPDATE medicine_inventory
        SET quantity_in_stock = quantity_in_stock + NEW.quantity
        WHERE id = NEW.inventory_id;
    ELSIF NEW.movement_type IN ('sale', 'expired', 'damaged', 'adjustment') THEN
        UPDATE medicine_inventory
        SET quantity_in_stock = quantity_in_stock - NEW.quantity
        WHERE id = NEW.inventory_id;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS update_stock_on_movement_trigger ON stock_movements;
CREATE TRIGGER update_stock_on_movement_trigger
    AFTER INSERT ON stock_movements
    FOR EACH ROW
    EXECUTE FUNCTION update_stock_on_movement();

-- =====================================================
-- SUCCESS MESSAGE
-- =====================================================

SELECT 'âœ… Phase 5 Inventory & Analytics migration completed successfully!' as status,
       'Stock management, purchase orders, and analytics are now ready' as details;</div>
      </div>

      <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-xl mt-8">
        <h3 class="font-bold text-green-900 mb-3">âœ… After Running This SQL:</h3>
        <ul class="space-y-2 text-green-800 text-sm">
          <li>âœ“ Supplier management system</li>
          <li>âœ“ Medicine inventory tracking</li>
          <li>âœ“ Batch & expiry management</li>
          <li>âœ“ Stock movement logging</li>
          <li>âœ“ Purchase order system</li>
          <li>âœ“ Automated stock alerts</li>
          <li>âœ“ Revenue analytics</li>
          <li>âœ“ Doctor performance tracking</li>
          <li>âœ“ Patient demographics</li>
          <li>âœ“ Disease trend analysis</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    function copySQL() {
      const sqlCode = document.getElementById('sqlCode').textContent;
      navigator.clipboard.writeText(sqlCode).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.innerHTML = 'âœ… Copied!';
        btn.className = 'bg-gradient-to-r from-green-600 to-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-2xl';
        
        setTimeout(() => {
          alert('âœ… SQL Copied!\n\nPaste in Supabase SQL Editor and Run!');
        }, 100);
      });
    }
  </script>
</body>
</html>